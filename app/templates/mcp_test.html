{% extends "base.html" %}

{% block title %}MCP ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-database text-info"></i> MCP ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸</h2>
            <a href="/web/" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> í™ˆìœ¼ë¡œ
            </a>
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- ì‹¤ê±°ë˜ê°€ ì¡°íšŒ -->
    <div class="col-md-6">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-chart-line"></i> ì•„íŒŒíŠ¸ ì‹¤ê±°ë˜ê°€ ì¡°íšŒ</h5>
            </div>
            <div class="card-body">
                <form id="apartment-form" class="needs-validation" novalidate>
                    <!-- ì§€ì—­ ì„ íƒ -->
                    <div class="mb-3">
                        <label class="form-label">ì§€ì—­ ì„ íƒ</label>
                        <div class="row g-2">
                            <div class="col-6">
                                <select class="form-select" id="sido_cd" name="sido_cd" required>
                                    <option value="">ì „ì²´</option>
                                    <option value="11">ì„œìš¸íŠ¹ë³„ì‹œ</option>
                                    <option value="26">ë¶€ì‚°ê´‘ì—­ì‹œ</option>
                                    <option value="27">ëŒ€êµ¬ê´‘ì—­ì‹œ</option>
                                    <option value="28">ì¸ì²œê´‘ì—­ì‹œ</option>
                                    <option value="29">ê´‘ì£¼ê´‘ì—­ì‹œ</option>
                                    <option value="30">ëŒ€ì „ê´‘ì—­ì‹œ</option>
                                    <option value="31">ìš¸ì‚°ê´‘ì—­ì‹œ</option>
                                    <option value="36">ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ</option>
                                    <option value="41">ê²½ê¸°ë„</option>
                                    <option value="43">ì¶©ì²­ë¶ë„</option>
                                    <option value="44">ì¶©ì²­ë‚¨ë„</option>
                                    <option value="45">ì „ë¼ë¶ë„</option>
                                    <option value="46">ì „ë¼ë‚¨ë„</option>
                                    <option value="47">ê²½ìƒë¶ë„</option>
                                    <option value="48">ê²½ìƒë‚¨ë„</option>
                                    <option value="50">ì œì£¼íŠ¹ë³„ìì¹˜ë„</option>
                                    <option value="51">ê°•ì›íŠ¹ë³„ìì¹˜ë„</option>
                                    <option value="52">ì „ë¶íŠ¹ë³„ìì¹˜ë„</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <select class="form-select" id="sgg_cd" name="sgg_cd" required>
                                    <option value="">ì‹œêµ°êµ¬ ì„ íƒ</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ë‚ ì§œ ë²”ìœ„ -->
                    <div class="mb-3">
                        <label class="form-label">ì¡°íšŒ ê¸°ê°„</label>
                        <div class="row g-2">
                            <div class="col-6">
                                <input type="date" class="form-control" id="date_from" name="date_from">
                            </div>
                            <div class="col-6">
                                <input type="date" class="form-control" id="date_to" name="date_to">
                            </div>
                        </div>
                    </div>
                    
                    <!-- í•„í„° ì˜µì…˜ -->
                    <div class="mb-3">
                        <div class="row g-2">
                            <div class="col-6">
                                <label for="area_range" class="form-label">ë©´ì ë²”ìœ„</label>
                                <select class="form-select" id="area_range" name="area_range">
                                    <option value="">ì „ì²´</option>
                                    <option value="60-85">60-85ã¡</option>
                                    <option value="85-100">85-100ã¡</option>
                                    <option value="100-130">100-130ã¡</option>
                                    <option value="130-165">130-165ã¡</option>
                                    <option value="165-">165ã¡+</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label for="deal_type" class="form-label">ê±°ë˜ìœ í˜•</label>
                                <select class="form-select" id="deal_type" name="deal_type">
                                    <option value="ë§¤ë§¤">ë§¤ë§¤</option>
                                    <option value="ì „ì„¸">ì „ì„¸</option>
                                    <option value="ì›”ì„¸">ì›”ì„¸</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ê°€ê²© ë²”ìœ„ -->
                    <div class="mb-3">
                        <label class="form-label">ê°€ê²©ë²”ìœ„ (ë§Œì›)</label>
                        <div class="row g-2">
                            <div class="col-6">
                                <input type="number" class="form-control" id="price_min" name="price_min" 
                                       placeholder="ìµœì†Œ" value="10">
                            </div>
                            <div class="col-6">
                                <input type="number" class="form-control" id="price_max" name="price_max" 
                                       placeholder="ìµœëŒ€" value="1000000">
                            </div>
                        </div>
                    </div>
                    
                    <!-- ì¶”ê°€ í•„í„° -->
                    <div class="mb-3">
                        <div class="row g-2">
                            <div class="col-6">
                                <select class="form-select" id="complex_name" name="complex_name" disabled>
                                    <option value="">ë‹¨ì§€ëª… ì„ íƒ (ì„ íƒì‚¬í•­)</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <input type="text" class="form-control" id="emd_name" name="emd_name" 
                                       placeholder="ìë©´ë™ (ì„ íƒì‚¬í•­)">
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary" id="apt-btn">
                            <i class="fas fa-search"></i> ê³ ê¸‰ ì‹¤ê±°ë˜ê°€ ì¡°íšŒ
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="loadLegacyForm()">
                            <i class="fas fa-undo"></i> ê¸°ì¡´ ë°©ì‹ìœ¼ë¡œ ì¡°íšŒ
                        </button>
                    </div>
                </form>
                <div id="apartment-result" class="mt-3"></div>
            </div>
        </div>
    </div>

    <!-- ë„ë¡œëª… ì£¼ì†Œ ê²€ìƒ‰ -->
    <div class="col-md-6">
        <div class="card shadow">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="fas fa-road"></i> ë„ë¡œëª… ì£¼ì†Œ ê²€ìƒ‰</h5>
            </div>
            <div class="card-body">
                <form id="road-address-form" class="needs-validation" novalidate>
                    <div class="mb-3">
                        <label for="road_address" class="form-label">ë„ë¡œëª… ì£¼ì†Œ</label>
                        <input type="text" class="form-control" id="road_address" name="road_address" 
                               placeholder="ì˜ˆ: ì¸ì²œ ì„œêµ¬ ê²€ì•”ë¡œ10ë²ˆê¸¸ 36" required>
                        <div class="form-text">ì‹œë„ ì‹œêµ°êµ¬ ë„ë¡œëª… ê±´ë¬¼ë²ˆí˜¸ í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”</div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="row g-2">
                            <div class="col-6">
                                <label for="road_date_from" class="form-label">ì¡°íšŒ ì‹œì‘ì¼</label>
                                <input type="text" class="form-control" id="road_date_from" name="road_date_from" 
                                       placeholder="YYYYMM" value="202506">
                            </div>
                            <div class="col-6">
                                <label for="road_date_to" class="form-label">ì¡°íšŒ ì¢…ë£Œì¼</label>
                                <input type="text" class="form-control" id="road_date_to" name="road_date_to" 
                                       placeholder="YYYYMM" value="202506">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="row g-2">
                            <div class="col-6">
                                <label for="road_property_type" class="form-label">ë¶€ë™ì‚° ìœ í˜•</label>
                                <select class="form-select" id="road_property_type" name="road_property_type">
                                    <option value="ì•„íŒŒíŠ¸">ì•„íŒŒíŠ¸</option>
                                    <option value="ì—°ë¦½ë‹¤ì„¸ëŒ€">ì—°ë¦½ë‹¤ì„¸ëŒ€</option>
                                    <option value="ë‹¨ë…ì£¼íƒ">ë‹¨ë…ì£¼íƒ</option>
                                    <option value="ì˜¤í”¼ìŠ¤í…”">ì˜¤í”¼ìŠ¤í…”</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label for="road_deal_type" class="form-label">ê±°ë˜ ìœ í˜•</label>
                                <select class="form-select" id="road_deal_type" name="road_deal_type">
                                    <option value="ë§¤ë§¤">ë§¤ë§¤</option>
                                    <option value="ì „ì„¸">ì „ì„¸</option>
                                    <option value="ì›”ì„¸">ì›”ì„¸</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-danger w-100">
                        <i class="fas fa-search"></i> ë„ë¡œëª… ì£¼ì†Œë¡œ ê²€ìƒ‰
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- ì§€í•˜ì² ì—­ ê²€ìƒ‰ -->
    <div class="col-md-6">
        <div class="card shadow">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-subway"></i> ì§€í•˜ì² ì—­ ê±°ë¦¬ ê²€ìƒ‰</h5>
            </div>
            <div class="card-body">
                <form id="subway-form" class="needs-validation" novalidate>
                    <div class="mb-3">
                        <label for="address" class="form-label">ì£¼ì†Œ</label>
                        <input type="text" class="form-control" id="address" name="address" 
                               placeholder="ì˜ˆ: ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ ì—­ì‚¼ë™" required>
                        <div class="invalid-feedback">ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
                    </div>
                    <div class="mb-3">
                        <label for="limit" class="form-label">ì¡°íšŒí•  ì—­ ê°œìˆ˜</label>
                        <select class="form-select" id="limit" name="limit">
                            <option value="3">3ê°œ</option>
                            <option value="5" selected>5ê°œ</option>
                            <option value="10">10ê°œ</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-info w-100" id="subway-btn">
                        <i class="fas fa-search"></i> ì§€í•˜ì² ì—­ ê²€ìƒ‰
                    </button>
                </form>
                <div id="subway-result" class="mt-3"></div>
            </div>
        </div>
    </div>

    <!-- í¸ì˜ì‹œì„¤ ê²€ìƒ‰ -->
    <div class="col-md-6">
        <div class="card shadow">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-store"></i> í¸ì˜ì‹œì„¤ ê²€ìƒ‰</h5>
            </div>
            <div class="card-body">
                <form id="facility-form" class="needs-validation" novalidate>
                    <div class="mb-3">
                        <label for="facility-address" class="form-label">ì£¼ì†Œ</label>
                        <input type="text" class="form-control" id="facility-address" name="address" 
                               placeholder="ì˜ˆ: ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ ì—­ì‚¼ë™" required>
                        <div class="invalid-feedback">ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
                    </div>
                    <div class="mb-3">
                        <label for="category" class="form-label">ì‹œì„¤ ì¹´í…Œê³ ë¦¬</label>
                        <select class="form-select" id="category" name="category">
                            <option value="í¸ì˜ì ">í¸ì˜ì </option>
                            <option value="ë§ˆíŠ¸">ë§ˆíŠ¸/ëŒ€í˜•ë§ˆíŠ¸</option>
                            <option value="ë³‘ì›">ë³‘ì›</option>
                            <option value="ì•½êµ­">ì•½êµ­</option>
                            <option value="í•™êµ">í•™êµ</option>
                            <option value="ê³µì›">ê³µì›</option>
                            <option value="ìŒì‹ì ">ìŒì‹ì </option>
                            <option value="ì¹´í˜">ì¹´í˜</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="radius" class="form-label">ê²€ìƒ‰ ë°˜ê²½ (ë¯¸í„°)</label>
                        <select class="form-select" id="radius" name="radius">
                            <option value="500">500m</option>
                            <option value="1000" selected>1km</option>
                            <option value="1500">1.5km</option>
                            <option value="2000">2km</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-success w-100" id="facility-btn">
                        <i class="fas fa-search"></i> í¸ì˜ì‹œì„¤ ê²€ìƒ‰
                    </button>
                </form>
                <div id="facility-result" class="mt-3"></div>
            </div>
        </div>
    </div>

    <!-- ìœ„ì¹˜ ì ìˆ˜ ê³„ì‚° -->
    <div class="col-md-6">
        <div class="card shadow">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="fas fa-calculator"></i> ìœ„ì¹˜ ì ìˆ˜ ê³„ì‚°</h5>
            </div>
            <div class="card-body">
                <form id="score-form" class="needs-validation" novalidate>
                    <div class="mb-3">
                        <label for="subway_distance" class="form-label">ì§€í•˜ì²  ê±°ë¦¬ (km)</label>
                        <input type="number" class="form-control" id="subway_distance" name="subway_distance" 
                               step="0.1" min="0" max="10" placeholder="ì˜ˆ: 0.8" required>
                        <div class="invalid-feedback">ì§€í•˜ì²  ê±°ë¦¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
                    </div>
                    <div class="mb-3">
                        <label for="facilities_count" class="form-label">í¸ì˜ì‹œì„¤ ê°œìˆ˜</label>
                        <input type="number" class="form-control" id="facilities_count" name="facilities_count" 
                               min="0" max="100" placeholder="ì˜ˆ: 25" required>
                        <div class="invalid-feedback">í¸ì˜ì‹œì„¤ ê°œìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
                    </div>
                    <div class="mb-3">
                        <label for="park_distance" class="form-label">ê³µì› ê±°ë¦¬ (km, ì„ íƒì‚¬í•­)</label>
                        <input type="number" class="form-control" id="park_distance" name="park_distance" 
                               step="0.1" min="0" max="5" placeholder="ì˜ˆ: 0.5">
                    </div>
                    <button type="submit" class="btn btn-warning w-100" id="score-btn">
                        <i class="fas fa-calculator"></i> ì ìˆ˜ ê³„ì‚°
                    </button>
                </form>
                <div id="score-result" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<!-- ê²°ê³¼ í‘œì‹œ ì˜ì—­ -->
<div class="row mt-4">
    <div class="col-12">
        <div id="result-area" class="d-none">
            <div class="card shadow">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-bar"></i> ì¡°íšŒ ê²°ê³¼</h5>
                </div>
                <div class="card-body" id="result-content">
                    <!-- ê²°ê³¼ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì‚½ì…ë©ë‹ˆë‹¤ -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// AJAX ìš”ì²­ ê³µí†µ í•¨ìˆ˜
async function makeRequest(url, data) {
    console.log('ğŸŒ [makeRequest] ìš”ì²­ ì‹œì‘');
    console.log('ğŸŒ [makeRequest] URL:', url);
    console.log('ğŸŒ [makeRequest] ìš”ì²­ ë°ì´í„°:', data);
    
    try {
        console.log('ğŸŒ [makeRequest] fetch ìš”ì²­ ì‹œì‘');
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        console.log('ğŸŒ [makeRequest] ì‘ë‹µ ìƒíƒœ:', response.status, response.statusText);
        console.log('ğŸŒ [makeRequest] ì‘ë‹µ í—¤ë”:', Object.fromEntries(response.headers.entries()));
        
        if (!response.ok) {
            console.error('ğŸŒ [makeRequest] HTTP ì˜¤ë¥˜:', response.status, response.statusText);
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('ğŸŒ [makeRequest] JSON íŒŒì‹± ì™„ë£Œ:', result);
        return result;
        
    } catch (error) {
        console.error('ğŸŒ [makeRequest] ìš”ì²­ ì‹¤íŒ¨:', error);
        console.error('ğŸŒ [makeRequest] ì˜¤ë¥˜ íƒ€ì…:', error.constructor.name);
        console.error('ğŸŒ [makeRequest] ì˜¤ë¥˜ ë©”ì‹œì§€:', error.message);
        return { success: false, error: error.message };
    }
}

// ì•„íŒŒíŠ¸ ì‹¤ê±°ë˜ê°€ ì¡°íšŒ í•¨ìˆ˜
async function searchApartmentTrade() {
    const lawdCd = document.getElementById('lawd_cd').value;
    const dealYmd = document.getElementById('deal_ymd').value;
    const button = document.getElementById('apt-btn');
    
    if (!lawdCd) {
        alert('ì§€ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
        return;
    }
    
    if (!dealYmd) {
        alert('ê³„ì•½ë…„ì›”ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
    }
    
    // ë²„íŠ¼ ë¡œë”© ìƒíƒœ
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ì¡°íšŒ ì¤‘...';
    button.disabled = true;
    
    try {
        const data = {
            tool_name: 'get_real_estate_data_advanced',
            parameters: {
                sido_cd: lawdCd.substring(0, 2), // ì²˜ìŒ 2ìë¦¬ê°€ ì‹œë„ ì½”ë“œ
                sgg_cd: lawdCd, // ì „ì²´ê°€ ì‹œêµ°êµ¬ ì½”ë“œ
                date_from: dealYmd,
                date_to: dealYmd,
                property_type: 'ì•„íŒŒíŠ¸'
            }
        };
        
        const result = await makeRequest('/web/api/mcp/test', data);
        showResult('ì•„íŒŒíŠ¸ ë§¤ë§¤ ì‹¤ê±°ë˜ê°€ ì¡°íšŒ', result);
        
    } catch (error) {
        console.error('ì‹¤ê±°ë˜ê°€ ì¡°íšŒ ì˜¤ë¥˜:', error);
        showResult('ì•„íŒŒíŠ¸ ë§¤ë§¤ ì‹¤ê±°ë˜ê°€ ì¡°íšŒ', { success: false, error: error.message });
    } finally {
        // ë²„íŠ¼ ì›ìƒë³µêµ¬
        button.innerHTML = originalText;
        button.disabled = false;
    }
}

// ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜
function showResult(title, data) {
    console.log('ğŸ¯ [showResult] ê²°ê³¼ í‘œì‹œ ì‹œì‘');
    console.log('ğŸ¯ [showResult] ì œëª©:', title);
    console.log('ğŸ¯ [showResult] ë°ì´í„°:', data);
    
    const resultArea = document.getElementById('result-area');
    const resultContent = document.getElementById('result-content');
    
    console.log('ğŸ¯ [showResult] resultArea:', resultArea);
    console.log('ğŸ¯ [showResult] resultContent:', resultContent);
    
    let html = `<h6><i class="fas fa-info-circle"></i> ${title}</h6>`;
    
    if (data.success) {
        html += '<div class="alert alert-success">ì¡°íšŒê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</div>';
        
        // ì‹¤ê±°ë˜ê°€ ë°ì´í„° íŠ¹ë³„ ì²˜ë¦¬
        if (data.data && data.data.items && Array.isArray(data.data.items)) {
            html += `<div class="alert alert-info">ì´ ${data.data.total_count || data.data.items.length}ê±´ì˜ ì‹¤ê±°ë˜ê°€ ë°ì´í„°ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.</div>`;
            
            if (data.data.items.length > 0) {
                html += '<div class="table-responsive">';
                html += '<table class="table table-striped table-sm">';
                html += '<thead class="table-dark"><tr>';
                
                // í•„ìš”í•œ ì»¬ëŸ¼ë§Œ í‘œì‹œ (ìˆ«ì ë°ì´í„°ëŠ” ì œì™¸)
                const displayColumns = ['ì•„íŒŒíŠ¸ëª…', 'ì „ìš©ë©´ì ', 'ê±°ë˜ê¸ˆì•¡', 'í‰ë‹¹ê°€ê²©', 'ì¸µ', 'ê±´ì¶•ë…„ë„', 'ê±´ë¬¼ì—°ì‹', 'ê³„ì•½ë…„ì›”', 'ê³„ì•½ì¼', 'ë²•ì •ë™'];
                displayColumns.forEach(col => {
                    html += `<th>${col}</th>`;
                });
                html += '</tr></thead><tbody>';
                
                // ë°ì´í„° í–‰ (ìµœëŒ€ 15ê°œë§Œ í‘œì‹œ)
                const displayItems = data.data.items.slice(0, 15);
                displayItems.forEach(item => {
                    html += '<tr>';
                    displayColumns.forEach(col => {
                        const value = item[col] || '';
                        // ê±°ë˜ê¸ˆì•¡ê³¼ í‰ë‹¹ê°€ê²©ì€ êµµê²Œ í‘œì‹œ
                        if (col === 'ê±°ë˜ê¸ˆì•¡' || col === 'í‰ë‹¹ê°€ê²©') {
                            html += `<td><strong class="text-primary">${value}</strong></td>`;
                        } else if (col === 'ì•„íŒŒíŠ¸ëª…') {
                            html += `<td><strong>${value}</strong></td>`;
                        } else if (col === 'ê±´ë¬¼ì—°ì‹' && value) {
                            // ì—°ì‹ì— ë”°ë¼ ìƒ‰ìƒ í‘œì‹œ (5ë…„ ì´í•˜: ë…¹ìƒ‰, 20ë…„ ì´ìƒ: ì£¼í™©)
                            const years = parseInt(value.replace('ë…„', ''));
                            if (years <= 5) {
                                html += `<td><span class="badge bg-success">${value}</span></td>`;
                            } else if (years >= 20) {
                                html += `<td><span class="badge bg-warning text-dark">${value}</span></td>`;
                            } else {
                                html += `<td>${value}</td>`;
                            }
                        } else {
                            html += `<td>${value}</td>`;
                        }
                    });
                    html += '</tr>';
                });
                
                html += '</tbody></table></div>';
                
                if (data.data.items.length > 15) {
                    html += `<div class="alert alert-info">ìƒìœ„ 15ê±´ë§Œ í‘œì‹œë©ë‹ˆë‹¤. ì „ì²´ ${data.data.items.length}ê±´</div>`;
                }
                
                // ê°„ë‹¨í•œ í†µê³„ ì •ë³´ í‘œì‹œ
                if (data.data.items.length > 0) {
                    const prices = data.data.items.map(item => item.ê±°ë˜ê¸ˆì•¡_ìˆ«ì || 0).filter(p => p > 0);
                    const pyeongPrices = data.data.items.map(item => item.í‰ë‹¹ê°€ê²©_ìˆ«ì || 0).filter(p => p > 0);
                    
                    if (prices.length > 0) {
                        const avgPrice = Math.round(prices.reduce((a, b) => a + b, 0) / prices.length);
                        const maxPrice = Math.max(...prices);
                        const minPrice = Math.min(...prices);
                        
                        html += '<div class="row mt-3">';
                        html += '<div class="col-12">';
                        html += '<div class="card bg-light">';
                        html += '<div class="card-body">';
                        html += '<h6 class="card-title"><i class="fas fa-chart-bar"></i> ê±°ë˜ê¸ˆì•¡ í†µê³„</h6>';
                        html += `<div class="row text-center">`;
                        html += `<div class="col-4"><small class="text-muted">í‰ê· </small><br><strong class="text-info">${avgPrice.toLocaleString()}ë§Œì›</strong></div>`;
                        html += `<div class="col-4"><small class="text-muted">ìµœê³ </small><br><strong class="text-success">${maxPrice.toLocaleString()}ë§Œì›</strong></div>`;
                        html += `<div class="col-4"><small class="text-muted">ìµœì €</small><br><strong class="text-danger">${minPrice.toLocaleString()}ë§Œì›</strong></div>`;
                        html += `</div>`;
                        html += '</div></div></div></div>';
                    }
                }
            }
        } else {
            html += '<pre class="bg-light p-3 rounded"><code>' + JSON.stringify(data.data, null, 2) + '</code></pre>';
        }
    } else {
        html += '<div class="alert alert-danger">ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (data.error || data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜') + '</div>';
        
        // API í‚¤ ì„¤ì • ì•ˆë‚´
        if (data.error && data.error.includes('API')) {
            html += '<div class="alert alert-warning">';
            html += '<h6><i class="fas fa-exclamation-triangle"></i> API í‚¤ ì„¤ì • ì•ˆë‚´</h6>';
            html += '<p>ì‹¤ê±°ë˜ê°€ ì¡°íšŒë¥¼ ìœ„í•´ì„œëŠ” ë‹¤ìŒ API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤:</p>';
            html += '<ul>';
            html += '<li><strong>MOLIT_API_KEY</strong>: êµ­í† êµí†µë¶€ ê³µê³µë°ì´í„°í¬í„¸ API í‚¤</li>';
            html += '<li><strong>NAVER_CLIENT_ID, NAVER_CLIENT_SECRET</strong>: ë„¤ì´ë²„ í´ë¼ìš°ë“œ í”Œë«í¼ API í‚¤</li>';
            html += '</ul>';
            html += '<p>Railway í™˜ê²½ë³€ìˆ˜ì—ì„œ ì„¤ì •í•´ì£¼ì„¸ìš”.</p>';
            html += '</div>';
        }
    }
    
    resultContent.innerHTML = html;
    resultArea.classList.remove('d-none');
    resultArea.scrollIntoView({ behavior: 'smooth' });
}

// ë²„íŠ¼ ë¡œë”© ìƒíƒœ í•¨ìˆ˜
function showLoading(buttonId) {
    const button = document.getElementById(buttonId);
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ì²˜ë¦¬ ì¤‘...';
    button.disabled = true;
    return originalText;
}

function hideLoading(buttonId, originalText) {
    const button = document.getElementById(buttonId);
    button.innerHTML = originalText;
    button.disabled = false;
}

// DOM ë¡œë”© í™•ì¸
console.log('ğŸ”§ [DOM] DOM ë¡œë”© ì‹œì‘');
console.log('ğŸ”§ [DOM] í˜„ì¬ URL:', window.location.href);
console.log('ğŸ”§ [DOM] ë¬¸ì„œ ì¤€ë¹„ ìƒíƒœ:', document.readyState);
console.log('ğŸ”§ [DOM] apartment-form ìš”ì†Œ:', document.getElementById('apartment-form'));
console.log('ğŸ”§ [DOM] apt-btn ìš”ì†Œ:', document.getElementById('apt-btn'));

// ë²„íŠ¼ í´ë¦­ ë””ë²„ê¹… (ì§ì ‘ í´ë¦­ ì‹œì—ë„ í™•ì¸)
const aptBtn = document.getElementById('apt-btn');
if (aptBtn) {
    console.log('ğŸ”§ [DOM] apt-btn ë²„íŠ¼ ì°¾ìŒ, ì§ì ‘ í´ë¦­ ì´ë²¤íŠ¸ë„ ë“±ë¡');
    aptBtn.addEventListener('click', function(e) {
        console.log('ğŸ–±ï¸ [ë²„íŠ¼ í´ë¦­] apt-btn ì§ì ‘ í´ë¦­ë¨');
        console.log('ğŸ–±ï¸ [ë²„íŠ¼ í´ë¦­] ì´ë²¤íŠ¸:', e);
        console.log('ğŸ–±ï¸ [ë²„íŠ¼ í´ë¦­] ë²„íŠ¼ íƒ€ì…:', e.target.type);
        console.log('ğŸ–±ï¸ [ë²„íŠ¼ í´ë¦­] ë¶€ëª¨ í¼:', e.target.form);
    });
}

// ì•„íŒŒíŠ¸ ì‹¤ê±°ë˜ê°€ ì¡°íšŒ í¼
const apartmentForm = document.getElementById('apartment-form');
if (apartmentForm) {
    console.log('âœ… [DOM] apartment-form ì°¾ìŒ, ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡');
    apartmentForm.addEventListener('submit', async function(e) {
    console.log('ğŸ  [ì‹¤ê±°ë˜ê°€ ì¡°íšŒ] í¼ submit ì´ë²¤íŠ¸ ë°œìƒ');
    e.preventDefault();
    
    // ë²„íŠ¼ ìƒíƒœ ë””ë²„ê¹…
    const button = document.getElementById('apt-btn');
    console.log('ğŸ”˜ [ë²„íŠ¼ ìƒíƒœ] í˜„ì¬ ë²„íŠ¼:', button);
    console.log('ğŸ”˜ [ë²„íŠ¼ ìƒíƒœ] disabled:', button.disabled);
    console.log('ğŸ”˜ [ë²„íŠ¼ ìƒíƒœ] innerHTML:', button.innerHTML);
    
    const originalText = showLoading('apt-btn');
    console.log('ğŸ”„ [ë¡œë”©] showLoading í˜¸ì¶œ ì™„ë£Œ, originalText:', originalText);
    
    try {
        // í¼ ë°ì´í„° ë””ë²„ê¹…
        const formData = new FormData(e.target);
        console.log('ğŸ“ [í¼ ë°ì´í„°] FormData ìƒì„± ì™„ë£Œ');
        console.log('ğŸ“ [í¼ ë°ì´í„°] formData entries:', [...formData.entries()]);
        
        // ìƒˆë¡œìš´ ê³ ê¸‰ íŒŒë¼ë¯¸í„° ìˆ˜ì§‘
        const sidoCd = formData.get('sido_cd') || document.getElementById('sido_cd').value;
        const sggCd = formData.get('sgg_cd') || document.getElementById('sgg_cd').value;
        const dateFrom = formData.get('date_from') || document.getElementById('date_from').value;
        const dateTo = formData.get('date_to') || document.getElementById('date_to').value;
        const areaRange = formData.get('area_range') || document.getElementById('area_range').value;
        const dealType = formData.get('deal_type') || document.getElementById('deal_type').value;
        const priceMin = formData.get('price_min') || document.getElementById('price_min').value;
        const priceMax = formData.get('price_max') || document.getElementById('price_max').value;
        const complexName = formData.get('complex_name') || document.getElementById('complex_name').value;
        const emdName = formData.get('emd_name') || document.getElementById('emd_name').value;
        
        console.log('ğŸ˜ï¸ [ì…ë ¥ê°’] sidoCd:', sidoCd);
        console.log('ğŸ˜ï¸ [ì…ë ¥ê°’] sggCd:', sggCd);
        console.log('ğŸ“… [ì…ë ¥ê°’] dateFrom:', dateFrom);
        console.log('ğŸ“… [ì…ë ¥ê°’] dateTo:', dateTo);
        console.log('ğŸ¢ [ì…ë ¥ê°’] areaRange:', areaRange);
        console.log('ğŸ’° [ì…ë ¥ê°’] dealType:', dealType);
        console.log('ğŸ’° [ì…ë ¥ê°’] priceRange:', priceMin, '-', priceMax);
        
        if (!sidoCd || !sggCd) {
            console.error('âŒ [ê²€ì¦] ì§€ì—­ ì •ë³´ ì—†ìŒ');
            alert('ì‹œë„ì™€ ì‹œêµ°êµ¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”');
            return;
        }
        
        const data = {
            tool_name: 'get_real_estate_data_advanced',
            parameters: {
                sido_cd: sidoCd,
                sgg_cd: sggCd,
                emd_name: emdName,
                complex_name: complexName,
                area_range: areaRange,
                price_range_min: parseInt(priceMin) || 10,
                price_range_max: parseInt(priceMax) || 1000000,
                date_from: dateFrom,
                date_to: dateTo,
                deal_type: dealType,
                property_type: 'ì•„íŒŒíŠ¸',
                use_xml_api: false  // CSV ë°©ì‹ ì‚¬ìš©
            }
        };
        
        console.log('ğŸ“¤ [API ìš”ì²­] ìš”ì²­ ë°ì´í„°:', data);
        console.log('ğŸ“¤ [API ìš”ì²­] ìš”ì²­ URL: /web/api/mcp/test');
        
        const result = await makeRequest('/web/api/mcp/test', data);
        console.log('ğŸ“¥ [API ì‘ë‹µ] ì‘ë‹µ ë°›ìŒ:', result);
        
        showResult('ì•„íŒŒíŠ¸ ë§¤ë§¤ ì‹¤ê±°ë˜ê°€ ì¡°íšŒ', result);
        console.log('âœ… [ì™„ë£Œ] showResult í˜¸ì¶œ ì™„ë£Œ');
        
    } catch (error) {
        console.error('ğŸ’¥ [ì˜¤ë¥˜] ì‹¤ê±°ë˜ê°€ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜:', error);
        console.error('ğŸ’¥ [ì˜¤ë¥˜] ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤:', error.stack);
        showResult('ì•„íŒŒíŠ¸ ë§¤ë§¤ ì‹¤ê±°ë˜ê°€ ì¡°íšŒ ì˜¤ë¥˜', { 
            success: false, 
            error: error.message,
            stack: error.stack 
        });
    } finally {
        hideLoading('apt-btn', originalText);
        console.log('ğŸ”„ [ë¡œë”©] hideLoading í˜¸ì¶œ ì™„ë£Œ');
        
        // ìµœì¢… ë²„íŠ¼ ìƒíƒœ í™•ì¸
        const finalButton = document.getElementById('apt-btn');
        console.log('ğŸ”˜ [ìµœì¢… ë²„íŠ¼ ìƒíƒœ] disabled:', finalButton.disabled);
        console.log('ğŸ”˜ [ìµœì¢… ë²„íŠ¼ ìƒíƒœ] innerHTML:', finalButton.innerHTML);
    }
    });
} else {
    console.error('âŒ [DOM] apartment-form ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ!');
    console.log('ğŸ”§ [DOM] ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë“  form ìš”ì†Œë“¤:');
    document.querySelectorAll('form').forEach((form, index) => {
        console.log(`ğŸ”§ [DOM] Form ${index}:`, form, 'ID:', form.id, 'Classes:', form.className);
    });
}

// ì§€í•˜ì² ì—­ ê²€ìƒ‰ í¼
document.getElementById('subway-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const originalText = showLoading('subway-btn');
    
    try {
        const formData = new FormData(e.target);
        const data = {
            tool_name: 'find_nearest_subway_stations',
            parameters: {
                address: formData.get('address'),
                limit: parseInt(formData.get('limit'))
            }
        };
        
        const result = await makeRequest('/web/api/mcp/test', data);
        showResult('ì§€í•˜ì² ì—­ ê²€ìƒ‰ ê²°ê³¼', result);
    } finally {
        hideLoading('subway-btn', originalText);
    }
});

// ë„ë¡œëª… ì£¼ì†Œ ê²€ìƒ‰ í¼
document.getElementById('road-address-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const button = e.target.querySelector('button[type="submit"]');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ê²€ìƒ‰ ì¤‘...';
    button.disabled = true;
    
    try {
        const formData = new FormData(e.target);
        const data = {
            tool_name: 'search_by_road_address',
            parameters: {
                road_address: formData.get('road_address'),
                date_from: formData.get('road_date_from'),
                date_to: formData.get('road_date_to'),
                property_type: formData.get('road_property_type'),
                deal_type: formData.get('road_deal_type')
            }
        };
        
        const result = await makeRequest('/web/api/mcp/test', data);
        showResult('ë„ë¡œëª… ì£¼ì†Œ ê²€ìƒ‰ ê²°ê³¼', result);
    } finally {
        button.innerHTML = originalText;
        button.disabled = false;
    }
});

// í¸ì˜ì‹œì„¤ ê²€ìƒ‰ í¼
document.getElementById('facility-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const originalText = showLoading('facility-btn');
    
    try {
        const formData = new FormData(e.target);
        const data = {
            tool_name: 'find_nearby_facilities',
            parameters: {
                address: formData.get('address'),
                category: formData.get('category'),
                radius: parseInt(formData.get('radius'))
            }
        };
        
        const result = await makeRequest('/web/api/mcp/test', data);
        showResult('í¸ì˜ì‹œì„¤ ê²€ìƒ‰ ê²°ê³¼', result);
    } finally {
        hideLoading('facility-btn', originalText);
    }
});

// ìœ„ì¹˜ ì ìˆ˜ ê³„ì‚° í¼
document.getElementById('score-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const originalText = showLoading('score-btn');
    
    try {
        const formData = new FormData(e.target);
        const data = {
            tool_name: 'calculate_location_score',
            parameters: {
                subway_distance: parseFloat(formData.get('subway_distance')),
                facilities_count: parseInt(formData.get('facilities_count')),
                park_distance: formData.get('park_distance') ? parseFloat(formData.get('park_distance')) : null
            }
        };
        
        const result = await makeRequest('/web/api/mcp/test', data);
        showResult('ìœ„ì¹˜ ì ìˆ˜ ê³„ì‚° ê²°ê³¼', result);
    } finally {
        hideLoading('score-btn', originalText);
    }
});

// í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ë³¸ê°’ ì„¤ì •
document.addEventListener('DOMContentLoaded', function() {
    // ê¸°ë³¸ ë‚ ì§œ ì„¤ì • (ìµœê·¼ 1ê°œì›”)
    const today = new Date();
    const oneMonthAgo = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
    
    const dateFromInput = document.getElementById('date_from');
    const dateToInput = document.getElementById('date_to');
    
    if (dateFromInput && dateToInput) {
        dateFromInput.value = oneMonthAgo.toISOString().split('T')[0];
        dateToInput.value = today.toISOString().split('T')[0];
    }
    
    console.log('ğŸ“… [ì´ˆê¸°í™”] ê¸°ë³¸ ë‚ ì§œ ì„¤ì • ì™„ë£Œ');
});

// ê¸°ì¡´ ë°©ì‹ìœ¼ë¡œ ì¡°íšŒ ë²„íŠ¼
function loadLegacyForm() {
    const confirmed = confirm('ê¸°ì¡´ ë°©ì‹(ë‹¨ìˆœ ì§€ì—­ì½”ë“œ+ë…„ì›”)ìœ¼ë¡œ ì „í™˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní˜„ì¬ ì…ë ¥ëœ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.');
    
    if (confirmed) {
        // í¼ ë‚´ìš©ì„ ê¸°ì¡´ ë°©ì‹ìœ¼ë¡œ êµì²´
        const formHtml = `
            <div class="mb-3">
                <label for="lawd_cd_legacy" class="form-label">ì§€ì—­ì½”ë“œ</label>
                <select class="form-select" id="lawd_cd_legacy" name="lawd_cd" required>
                    <option value="">ì§€ì—­ì„ ì„ íƒí•˜ì„¸ìš”</option>
                    <option value="11680">ì„œìš¸ ê°•ë‚¨êµ¬</option>
                    <option value="11710">ì„œìš¸ ì„œì´ˆêµ¬</option>
                    <option value="11740">ì„œìš¸ ì†¡íŒŒêµ¬</option>
                    <option value="11500">ì„œìš¸ ê°•ì„œêµ¬</option>
                    <option value="41131">ê²½ê¸° ìˆ˜ì›ì‹œ</option>
                    <option value="41173">ê²½ê¸° ì„±ë‚¨ì‹œ</option>
                    <option value="41285">ê²½ê¸° í‰íƒì‹œ</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="deal_ymd_legacy" class="form-label">ê³„ì•½ë…„ì›”</label>
                <input type="text" class="form-control" id="deal_ymd_legacy" name="deal_ymd" 
                       placeholder="202401" value="202407" required>
                <div class="form-text">YYYYMM í˜•ì‹ (ì˜ˆ: 202407)</div>
            </div>
            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary" id="apt-btn">
                    <i class="fas fa-search"></i> ê¸°ì¡´ ë°©ì‹ ì¡°íšŒ
                </button>
                <button type="button" class="btn btn-outline-success" onclick="location.reload()">
                    <i class="fas fa-sync"></i> ê³ ê¸‰ ë°©ì‹ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                </button>
            </div>
        `;
        
        const form = document.getElementById('apartment-form');
        // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° í›„ ìƒˆ ë‚´ìš©ìœ¼ë¡œ êµì²´
        const newForm = document.createElement('form');
        newForm.id = 'apartment-form';
        newForm.className = 'needs-validation';
        newForm.setAttribute('novalidate', '');
        newForm.innerHTML = formHtml;
        
        form.parentNode.replaceChild(newForm, form);
        
        // ê¸°ì¡´ ë°©ì‹ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        setupLegacyForm();
        
        alert('ê¸°ì¡´ ë°©ì‹ìœ¼ë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }
}

// ê¸°ì¡´ ë°©ì‹ í¼ ì´ë²¤íŠ¸ ì„¤ì •
function setupLegacyForm() {
    const legacyForm = document.getElementById('apartment-form');
    if (legacyForm) {
        legacyForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const originalText = showLoading('apt-btn');
            
            try {
                const formData = new FormData(e.target);
                const lawdCd = formData.get('lawd_cd');
                const dealYmd = formData.get('deal_ymd');
                
                if (!lawdCd || !dealYmd) {
                    alert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                const data = {
                    tool_name: 'get_real_estate_data_advanced',
                    parameters: {
                        sido_cd: lawdCd.substring(0, 2), // ì²˜ìŒ 2ìë¦¬ê°€ ì‹œë„ ì½”ë“œ
                        sgg_cd: lawdCd, // ì „ì²´ê°€ ì‹œêµ°êµ¬ ì½”ë“œ
                        date_from: dealYmd,
                        date_to: dealYmd,
                        property_type: 'ì•„íŒŒíŠ¸'
                    }
                };
                
                const result = await makeRequest('/web/api/mcp/test', data);
                showResult('ì‹¤ê±°ë˜ê°€ ì¡°íšŒ ê²°ê³¼ (ê¸°ì¡´ ë°©ì‹)', result);
            } finally {
                hideLoading('apt-btn', originalText);
            }
        });
    }
}

// ì‹œë„ ë³€ê²½ ì‹œ ì‹œêµ°êµ¬ ë™ì  ë¡œë”©
document.getElementById('sido_cd').addEventListener('change', async function() {
    const sidoCd = this.value;
    const sggSelect = document.getElementById('sgg_cd');
    
    // ì‹œêµ°êµ¬ ì„ íƒ ì´ˆê¸°í™”
    sggSelect.innerHTML = '<option value="">ì‹œêµ°êµ¬ ì„ íƒ</option>';
    
    if (sidoCd) {
        try {
            // ì‹œêµ°êµ¬ ëª©ë¡ ìš”ì²­
            const response = await fetch(`/web/api/regions/sigungu/${sidoCd}`);
            const data = await response.json();
            
            if (data.success && data.data) {
                // ì‹œêµ°êµ¬ ì˜µì…˜ ì¶”ê°€
                data.data.forEach(sigungu => {
                    const option = document.createElement('option');
                    option.value = sigungu.code;
                    option.textContent = sigungu.name;
                    sggSelect.appendChild(option);
                });
            }
        } catch (error) {
            console.error('ì‹œêµ°êµ¬ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨:', error);
        }
    }
});
</script>
{% endblock %}